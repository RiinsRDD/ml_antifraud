# Архитектура микросервиса оценки финансовых транзакций

## Общая архитектура

Система построена по следующим принципам:

1. **Service Layer Architecture** - Четкое разделение бизнес-логики
2. **Repository Pattern** - Абстракция работы с данными (в данном случае Redis)
3. **Dependency Injection** - Внедрение зависимостей через FastAPI
4. **Clean Architecture** - Четкое разделение слоев: API, Service, Repository, Models
5. **Микросервисная архитектура** - Система спроектирована как отдельный микросервис

## Структура слоев

### 1. API Layer (Представление)
- **Файлы**: `api/routes/transaction.py`
- **Ответственность**: Обработка HTTP запросов, маршрутизация, валидация входных данных
- **Входные данные**: JSON с данными транзакции
- **Выходные данные**: JSON с результатом оценки

### 2. Service Layer (Бизнес логика)
- **Файлы**: `services/transaction_service.py`, `services/scoring_service.py`, `services/transaction_service_impl.py`, `services/scoring_service_impl.py`
- **Ответственность**:
  - Обработка логики транзакции
  - Вызов ML модели для оценки
  - Расчет статистики по клиенту
  - Обработка ошибок и таймаутов
- **Связи**: Зависит от Repository для работы с данными
- **Реализации**: `TransactionServiceImpl`, `ScoringServiceImpl` с async/await

### 3. Repository Layer (Доступ к данным)
- **Файлы**: `repositories/transaction_repository.py`, `repositories/redis_transaction_repository.py`
- **Ответственность**:
  - Интерфейс для работы с Redis кэшем
  - Добавление/извлечение транзакций
  - Расчет статистики
- **Реализация**: `RedisTransactionRepository` с async redis.asyncio и connection pooling

### 4. Model Layer (Модели данных)
- **Файлы**: `models/transaction.py`, `models/scoring.py`
- **Ответственность**:
  - Определение структуры данных
  - Валидация входных и выходных данных
  - JSON схемы для API

### 5. Utilities/Support Layer
- **Файлы**: `utils/logger.py`, `api/middleware/logging.py`
- **Ответственность**:
  - Логгирование запросов
  - Middleware для обработки запросов

### 6. Main Application Layer
- **Файл**: `main.py`
- **Ответственность**:
  - Точка входа FastAPI приложения
  - Настройка мониторинга (Prometheus)
  - Регистрация маршрутов
  - Dependency Injection провайдеры
  - Singleton сервисов через app state

### 6. Monitoring Layer (Мониторинг)
- **Файлы**: `monitoring/metrics.py`
- **Ответственность**:
  - Настройка метрик Prometheus
  - Экспорт метрик для системы мониторинга

### 7. Load Generation Layer (Генератор трафика)
- **Файлы**: `load_generator/traffic_generator.py`
- **Ответственность**:
  - Генерация нагрузки для тестирования
  - Симуляция транзакций с различными параметрами
  - Отслеживание статистики обработки

## Путь запроса (Request Flow)

### 1. Входящий запрос
Клиент отправляет POST запрос на `/api/v1/transactions` с JSON телом:

```json
{
  "customer_id": "customer_123",
  "transaction_id": "txn_456",
  "amount": 100.50,
  "currency": "USD",
  "type": 78,
  "merchant_id": "merchant_789",
  "card_bin": "411111",
  "ip_address": "192.168.1.1",
  "device_id": "device_001",
  "location": "US-NY",
  "channel": "online",
  "timestamp": "2023-01-01T10:00:00Z"
}
```

### 2. API обработчик
- **Файл**: `api/routes/transaction.py`
- **Действие**: Принимает запрос, валидирует данные с помощью Pydantic модели `Transaction`
- **Логирование**: Записывает информацию о входящем запросе в логи
- **Передача**: Передает данные в `TransactionService`

### 3. Service Layer (Обработка транзакции)
- **Файл**: `services/transaction_service.py`
- **Действие**:
  - Валидация транзакции
  - Замер времени начала обработки
  - Добавление транзакции в кэш (Redis)
  - Получение истории транзакций по клиенту
  - Расчет статистики для клиента
  - Вызов Scoring Service

### 4. Repository Layer (Работа с кэшем)
- **Файл**: `repositories/transaction_repository.py`
- **Действие**:
  - Добавление транзакции в Redis с TTL 24 часа
  - Получение всех транзакций по customer_id
  - Изменение счетчиков и статистики
  - Обновление вспомогательных данных для расчета средних значений

### 5. Scoring Service (Оценка с ML)
- **Файл**: `services/scoring_service.py`
- **Действие**:
  - Вызов ML модели для оценки транзакции
  - Если модель не отвечает вовремя - возвращается значение по умолчанию
  - Возврат результата оценки

### 6. Формирование ответа
- **Файл**: `services/transaction_service.py`
- **Действие**:
  - Формирование полного ответа с результатом оценки
  - Расчет времени обработки (должно быть <= 100-200ms)
  - Добавление всех необходимых статистических данных
  - Запись в логи о завершении обработки

### 7. Возвращение ответа
- **Файл**: `api/routes/transaction.py`
- **Действие**:
  - Формирование JSON ответа по модели `ScoringResult`
  - Отправка HTTP ответа клиенту с кодом 200
  - Запись в логи о завершении запроса и времени обработки

## Схема взаимодействия

```
[Клиент]
    ↓
[API Layer] → [Service Layer] → [Repository Layer] → [Redis]
    ↑                              ↓
    |                      [Scoring Service]
    |                              ↓
    |                      [ML Model (заглушка)]
    |                              ↓
    ↓                        [Возврат результата]
[Ответ JSON]
```

## Требования к производительности

1. **Время обработки**: Не более 200мс
2. **Максимальное время оценки**: 100мс для ML модели
3. **Таймаут по умолчанию**: Если ML модель не отвечает, возвращать значение по умолчанию (0.5)
4. **Кэш**: 24 часа жизни записей, автоматическое удаление истекших

## Логгирование

Все действия логгируются с использованием Loguru:
- Входящие запросы с ID транзакции
- Завершение обработки запроса с временем выполнения
- Ошибки обработки
- Системные события (запуск/остановка сервиса)

## Ошибки и обработка

1. **Валидация данных**: Происходит на уровне Pydantic
2. **Ошибки сервиса**: Возвращаются как HTTP 500
3. **Таймауты**: Специальная обработка через `ModelTimeoutError`
4. **Кэш ошибки**: Обработка ошибок Redis через `CacheError`

## Мониторинг и метрики

Система поддерживает комплексную систему мониторинга:

1. **Prometheus Metrics**:
   - Счетчики запросов по методам и эндпоинтам
   - Гистограммы времени обработки запросов
   - Gauge для отслеживания активных запросов

2. **Мониторинг Redis**:
   - Использование Redis Exporter для экспорта метрик Redis в Prometheus
   - Отслеживание состояния кэша и производительности

3. **Визуализация**:
   - Grafana для визуализации метрик
   - Конфигурация для настройки dashboards

4. **Логирование**:
   - Использование Loguru для детального логирования
   - Логи доступны для анализа в системы типа OpenSearch

## Генератор трафика

Для тестирования производительности и функциональности системы используется генератор трафика:

1. **Features**:
   - Асинхронная генерация транзакций с использованием aiohttp
   - Генерация случайных данных для транзакций
   - Настройка количества транзакций в секунду
   - Отслеживание статистики (успешные/ошибочные запросы)
   - Интеграция с мониторингом

2. **Конфигурация**:
   - Максимальное количество транзакций в секунду (по умолчанию 1000)
   - Возможность настройки URL сервиса
   - Поддержка различий в типах транзакций, валютах, каналах и т.д.

3. **Тестирование**:
   - Позволяет проверить производительность сервиса под нагрузкой
   - Отслеживает задержки и отказы
   - Используется для нагрузочного тестирования